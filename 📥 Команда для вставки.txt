üì• –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏

INSERT INTO DimDate (FullDate, Year, Month, Day)
SELECT DISTINCT
  TO_TIMESTAMP(timestamp)DATE AS FullDate,
  EXTRACT(YEAR FROM TO_TIMESTAMP(timestamp))INT,
  EXTRACT(MONTH FROM TO_TIMESTAMP(timestamp))INT,
  EXTRACT(DAY FROM TO_TIMESTAMP(timestamp))INT
FROM temp_ratings;

üîç –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö

SELECT  FROM DimDate LIMIT 10;

üé¨ 2. –ù–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã DimMovie

üì• –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ —Å –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ–º –≥–æ–¥–∞ –≤—ã–ø—É—Å–∫–∞ –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è

INSERT INTO DimMovie (MovieID, Title, Genre, YearReleased)
SELECT
  movieId,
  title,
  genres,
  CASE
    WHEN title ~ '(d{4})$'
      THEN SUBSTRING(title FROM '((d{4}))$')INT
    ELSE NULL
  END
FROM temp_movies
WHERE movieId NOT IN (SELECT MovieID FROM DimMovie);

üîç –ü—Ä–æ—Å–º–æ—Ç—Ä

SELECT  FROM DimMovie LIMIT 10;

üë§ 3. –ù–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã DimUser

üì• –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏

INSERT INTO DimUser (UserID)
SELECT DISTINCT userId FROM temp_ratings;

üîç –ü—Ä–æ—Å–º–æ—Ç—Ä

SELECT  FROM DimUser LIMIT 10;

üü° 4. –ù–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã FactRatings

üì• –ü—Ä–æ–±–Ω–∞—è –≤—Å—Ç–∞–≤–∫–∞ 1000 —Å—Ç—Ä–æ–∫

INSERT INTO FactRatings (DateID, MovieID, UserID, Rating)
SELECT
  d.DateID,
  r.movieId,
  r.userId,
  r.rating
FROM temp_ratings r
JOIN DimDate d ON d.FullDate = TO_TIMESTAMP(r.timestamp)DATE
JOIN DimMovie m ON m.MovieID = r.movieId
JOIN DimUser u ON u.UserID = r.userId
LIMIT 1000;

üì• –ü–æ–ª–Ω–∞—è –≤—Å—Ç–∞–≤–∫–∞

INSERT INTO FactRatings (DateID, MovieID, UserID, Rating)
SELECT
  d.DateID,
  r.movieId,
  r.userId,
  r.rating
FROM temp_ratings r
JOIN DimDate d ON d.FullDate = TO_TIMESTAMP(r.timestamp)DATE
JOIN DimMovie m ON m.MovieID = r.movieId
JOIN DimUser u ON u.UserID = r.userId;

üîç –ü—Ä–æ—Å–º–æ—Ç—Ä

SELECT  FROM FactRatings LIMIT 10;

